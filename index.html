<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>決済デモサイト</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <script async src="https://pay.google.com/gp/p/js/pay.js" onload="onGooglePayLoaded()"></script>

    <style>
        /* --- 基本設定とライト/ダークモードの変数定義 --- */
        :root {
            --bg-color: #f5f5f5; --text-color: #212121; --card-bg-color: #ffffff;
            --border-color: #e0e0e0; --primary-color: #1a73e8; --primary-text-color: #ffffff;
            --secondary-bg-color: #e9ecef; --secondary-text-color: #495057;
            --premium-color: #ffbf00; --premium-bg-color: #232f3e;
            --danger-color: #dc3545; --danger-text-color: #ffffff;
            --favorite-color: #e52165;
            --caution-bg-color: #fff3e0; --caution-text-color: #e65100; --caution-border-color: #ffd180;
            --spinner-color: #1a73e8; --overlay-bg-color: rgba(255, 255, 255, 0.8);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212; --text-color: #e0e0e0; --card-bg-color: #1e1e1e;
                --border-color: #424242; --primary-color: #82b1ff; --primary-text-color: #121212;
                --secondary-bg-color: #333; --secondary-text-color: #adb5bd;
                --danger-color: #f88379; --danger-text-color: #121212;
                --caution-bg-color: #3e2723; --caution-text-color: #ffcc80; --caution-border-color: #e65100;
                --spinner-color: #82b1ff; --overlay-bg-color: rgba(0, 0, 0, 0.7);
            }
        }
        
        /* --- アニメーション --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* --- 全体的なスタイル --- */
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }

        /* --- ヘッダー --- */
        .site-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid var(--border-color); background-color: var(--card-bg-color); position: sticky; top: 0; z-index: 1000; }
        .site-header h1 { font-size: 1.5rem; margin: 0; cursor: pointer; }
        .header-icons { display: flex; align-items: center; gap: 16px; }
        .icon-button { background: none; border: none; cursor: pointer; color: var(--text-color); position: relative; padding: 5px; }
        .icon-button svg { width: 24px; height: 24px; }
        .cart-badge { position: absolute; top: 0; right: 0; background-color: var(--primary-color); color: var(--primary-text-color); border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .premium-status { font-weight: bold; color: var(--primary-color); font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .premium-status svg { width: 20px; height: 20px; }

        /* --- メインコンテンツのアニメーション起点 --- */
        #product-list-page > *, #product-detail-page > .product-detail-content > * { opacity: 0; }

        /* --- 商品一覧 --- */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .product-card { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; opacity: 0; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
        .product-image { width: 100%; height: 150px; background-color: #ccc; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; color: #666; pointer-events: none; }
        .product-name { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
        .product-card p { flex-grow: 1; }
        .product-price { font-size: 1.5em; font-weight: bold; color: var(--primary-color); margin-bottom: 20px; }
        .detail-actions { display: flex; justify-content: center; align-items: center; gap: 15px; }

        /* --- ボタン類 --- */
        .btn { background-color: var(--primary-color); color: var(--primary-text-color); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: opacity 0.2s; flex-grow: 1; }
        .btn:hover { opacity: 0.8; }
        .btn-premium { background-color: var(--premium-color); color: #000; flex-grow: 0; }
        .btn-danger { background-color: var(--danger-color); color: var(--danger-text-color); }
        .favorite-btn { background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); border-radius: 50%; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--text-color); transition: background-color 0.2s, color 0.2s; }
        .favorite-btn.favorited { background-color: var(--favorite-color); color: white; border-color: var(--favorite-color); }
        .favorite-btn svg { width: 20px; height: 20px; }

        /* --- 商品詳細 --- */
        .quantity-control { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px 0; }
        .quantity-input { width: 60px; text-align: center; padding: 5px; border-radius: 4px; border: 1px solid var(--border-color); }
        #product-detail-page .product-image { height: 300px; }
        
        /* --- レビュー --- */
        .reviews-section { margin-top: 40px; text-align: left; }
        .review-card { background-color: var(--secondary-bg-color); padding: 15px; border-radius: 8px; margin-bottom: 10px; opacity: 0; }
        .review-form textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--card-bg-color); color: var(--text-color); min-height: 80px; }
        
        /* --- モーダル --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .modal.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--card-bg-color); padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; position: relative; transform: scale(0.95); transition: transform 0.3s; }
        .modal.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: var(--text-color); }
        
        /* --- カート --- */
        .cart-item { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .cart-item-img { width: 60px; height: 60px; background-color: #ccc; border-radius: 8px; }
        .cart-item-details { flex-grow: 1; }
        .cart-item-actions button { background: none; border: 1px solid var(--text-color); color: var(--text-color); border-radius: 4px; cursor: pointer; }
        .cart-total { text-align: right; font-size: 1.2rem; font-weight: bold; margin-top: 20px; }
        
        /* --- プレミアム & プロフィール --- */
        .feature-list { list-style: none; padding-left: 0; }
        .feature-list li { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .feature-list svg { width: 20px; height: 20px; color: var(--primary-color); flex-shrink: 0; }
        .profile-section { margin-top: 20px; }
        .profile-section h4 { border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .history-item, .favorite-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--secondary-bg-color); }
        .history-item-details { flex-grow: 1; }
        .history-item-date { font-size: 0.8rem; color: var(--secondary-text-color); }

        /* --- ローディング --- */
        .gpay-button-container { min-height: 40px; margin-top: 20px; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--overlay-bg-color); display: flex; justify-content: center; align-items: center; z-index: 99999; opacity: 1; transition: opacity 0.3s; }
        .loader { width: 80px; height: 80px; animation: rotate 1s linear infinite; transform-origin: center center; }
        .loader .path { stroke: var(--spinner-color); stroke-linecap: round; stroke-dasharray: 89 150; stroke-dashoffset: 0; }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loadingOverlay"><svg class="loader" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="3"></circle></svg></div>

    <header class="site-header">
        <h1 id="site-title">決済デモサイト</h1>
        <div class="header-icons">
            <div id="premium-status" class="premium-status"></div>
            <button id="premium-button" class="btn btn-premium">プレミアム</button>
            <button id="cart-button" class="icon-button"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cart" viewBox="0 0 16 16"><path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M3.102 4l1.313 7h8.17l1.313-7zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2m7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/></svg><span id="cart-badge" class="cart-badge hidden">0</span></button>
            <button id="user-profile-button" class="icon-button"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/></svg></button>
        </div>
    </header>

    <main id="app-container" class="container">
        <div id="product-list-page"><p class="caution">【デモ専用】このサイトは決済機能を試すためのデモページです。</p><h2>デモ商品一覧</h2><div id="product-grid" class="product-grid"></div></div>
        <div id="product-detail-page" class="hidden"></div>
    </main>

    <div id="cart-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3>ショッピングカート</h3><button class="modal-close-btn" data-target="cart-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg></button></div><div id="cart-items"></div><div id="cart-empty" class="hidden">カートは空です。</div><div id="cart-footer"><div id="cart-total" class="cart-total">合計: ¥0</div><div id="gpay-cart-container" class="gpay-button-container"></div></div></div></div>
    <div id="premium-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3>プレミアムメンバーシップ</h3><button class="modal-close-btn" data-target="premium-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg></button></div><p>メンバーシップに登録して、限定特典をお楽しみください。</p><ul class="feature-list"></ul><p><small>メンバーシップはいつでも解約できます。</small></p><h4>料金: ¥600/月 (デモ)</h4><div id="gpay-premium-container" class="gpay-button-container"></div></div></div>
    <div id="user-profile-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3>ユーザープロフィール</h3><button class="modal-close-btn" data-target="user-profile-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg></button></div><div id="user-profile-content"></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- データストア ---
        const products = [
            { id: 1, name: 'デモ商品 A', price: 100, description: '高品質な素材を使用したテスト用の商品Aです。様々な用途でお試しいただけます。', reviews: [{ author: 'デモユーザー1', text: '非常に使いやすかったです。' },{ author: 'デモユーザー2', text: 'テストに最適でした。' }] },
            { id: 2, name: 'デモ商品 B', price: 550, description: '多機能で便利なテスト用の商品Bです。パフォーマンスも良好です。', reviews: [{ author: 'デモユーザー3', text: '機能は素晴らしいです。' },{ author: 'デモユーザー4', text: 'デザインが好きです。' },{ author: 'デモユーザー5', text: '期待通りでした！' }] },
            { id: 3, name: 'デモ商品 C', price: 1200, description: 'プロフェッショナル向けの高性能なテスト商品C。最高の体験を提供します。', reviews: [] }
        ];
        let cart = [];
        let userId = localStorage.getItem('userId');
        let isPremiumMember = localStorage.getItem('isPremiumMember') === 'true';
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let purchaseHistory = JSON.parse(localStorage.getItem('purchaseHistory')) || [];

        // --- DOM要素 ---
        const getEl = (id) => document.getElementById(id);
        const loadingOverlay = getEl('loadingOverlay');
        const siteTitle = getEl('site-title');
        const productGrid = getEl('product-grid');
        const productListPage = getEl('product-list-page');
        const productDetailPage = getEl('product-detail-page');
        const premiumStatusEl = getEl('premium-status');
        const premiumButton = getEl('premium-button');
        const cartButton = getEl('cart-button');
        const userProfileButton = getEl('user-profile-button');
        const cartModal = getEl('cart-modal');
        const premiumModal = getEl('premium-modal');
        const userProfileModal = getEl('user-profile-modal');
        const cartBadge = getEl('cart-badge');
        const cartItemsContainer = getEl('cart-items');
        const cartEmptyMsg = getEl('cart-empty');
        const cartFooter = getEl('cart-footer');
        const cartTotalEl = getEl('cart-total');
        
        // --- 初期化 ---
        const init = () => {
            if (!userId) {
                userId = self.crypto.randomUUID();
                localStorage.setItem('userId', userId);
            }
            renderProductList();
            updateCartBadge();
            updatePremiumStatusUI();
            setupEventListeners();
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
            }, 500);
        };

        // --- イベントリスナー ---
        const setupEventListeners = () => {
            siteTitle.addEventListener('click', showProductListPage);
            cartButton.addEventListener('click', () => { updateCart(); cartModal.classList.add('visible'); });
            premiumButton.addEventListener('click', () => premiumModal.classList.add('visible'));
            userProfileButton.addEventListener('click', showUserProfile);
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', () => document.getElementById(btn.dataset.target).classList.remove('visible'));
            });
            productGrid.addEventListener('click', e => {
                const card = e.target.closest('.product-card');
                if (card) showProductDetailPage(parseInt(card.dataset.id, 10));
            });
            document.body.addEventListener('click', e => {
                if (e.target.closest('#cancel-premium-btn')) cancelPremium();
                if (e.target.closest('#reset-data-btn')) resetAllData();
                if (e.target.closest('.remove-from-cart-btn')) {
                    cart = cart.filter(item => item.id !== parseInt(e.target.closest('.remove-from-cart-btn').dataset.id, 10));
                    updateCart();
                }
            });
        };

        // --- UI更新 / ページ遷移 ---
        const applyFadeInAnimation = (containerSelector) => {
            document.querySelectorAll(`${containerSelector} > *`).forEach((el, index) => {
                el.style.animation = `fadeIn 0.5s ease-out ${index * 0.05}s forwards`;
            });
        };

        const showProductListPage = () => {
            productListPage.classList.remove('hidden');
            productDetailPage.classList.add('hidden');
            renderProductList();
        };

        const showProductDetailPage = (productId) => {
            productListPage.classList.add('hidden');
            productDetailPage.classList.remove('hidden');
            renderProductDetail(productId);
            window.scrollTo(0, 0);
        };
        
        // --- レンダリング関数 ---
        const renderProductList = () => {
            productGrid.innerHTML = '';
            products.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.id = product.id;
                card.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s forwards`;
                card.innerHTML = `<div class="product-image">デモ画像 ${product.name.slice(-1)}</div><div class="product-name">${product.name}</div><p>${product.description.substring(0, 30)}...</p><div class="product-price">¥${product.price.toLocaleString()}</div>`;
                productGrid.appendChild(card);
            });
            applyFadeInAnimation('#product-list-page');
        };

        const renderProductDetail = (productId) => {
            const product = products.find(p => p.id === productId);
            const isFavorited = favorites.includes(productId);
            productDetailPage.innerHTML = `<div class="product-detail-content">
                <button class="btn back-button" style="flex-grow:0; margin-bottom: 20px;">&larr; 商品一覧に戻る</button>
                <div class="product-image">デモ画像 ${product.name.slice(-1)}</div><h2>${product.name}</h2><p>${product.description}</p>
                <div class="product-price">¥${product.price.toLocaleString()}</div>
                <div class="quantity-control"><label for="quantity-input">数量:</label><input type="number" id="quantity-input" class="quantity-input" value="1" min="1" max="99"></div>
                <div class="detail-actions">
                    <button class="btn add-to-cart-btn" data-id="${product.id}">カートに入れる</button>
                    <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-id="${product.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16"><path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/></svg></button>
                </div>
                <div class="reviews-section"><h3>レビュー</h3><div id="reviews-list"></div><div class="review-form"><h4>レビューを投稿する</h4><textarea id="review-text" placeholder="コメントを入力..."></textarea><button id="submit-review-btn" class="btn">投稿</button></div></div>
            </div>`;
            renderReviews(productId);
            productDetailPage.querySelector('.back-button').addEventListener('click', showProductListPage);
            productDetailPage.querySelector('.add-to-cart-btn').addEventListener('click', e => addToCart(parseInt(e.target.dataset.id, 10), parseInt(getEl('quantity-input').value, 10)));
            productDetailPage.querySelector('.favorite-btn').addEventListener('click', e => toggleFavorite(parseInt(e.currentTarget.dataset.id, 10)));
            productDetailPage.querySelector('#submit-review-btn').addEventListener('click', () => { const text = getEl('review-text').value; if (text.trim()) addReview(productId, text); });
            applyFadeInAnimation('#product-detail-page > .product-detail-content');
        };

        const renderReviews = (productId) => {
            const reviewsList = getEl('reviews-list');
            const productReviews = products.find(p => p.id === productId).reviews;
            reviewsList.innerHTML = productReviews.length === 0 ? '<p>まだレビューはありません。</p>' : '';
            productReviews.forEach((review, index) => {
                const reviewEl = document.createElement('div');
                reviewEl.className = 'review-card';
                reviewEl.style.animation = `fadeIn 0.5s ease-out ${index * 0.15}s forwards`;
                reviewEl.innerHTML = `<strong>${review.author}:</strong><p>${review.text}</p>`;
                reviewsList.appendChild(reviewEl);
            });
        };

        // --- 機能別関数 ---
        const addToCart = (productId, quantity) => {
            if (isNaN(quantity) || quantity <= 0) return;
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) existingItem.quantity += quantity;
            else cart.push({ id: productId, quantity: quantity });
            updateCartBadge();
            alert(`${quantity}個の商品をカートに追加しました。`);
        };

        const updateCart = () => {
            const isEmpty = cart.length === 0;
            cartEmptyMsg.classList.toggle('hidden', !isEmpty);
            cartFooter.classList.toggle('hidden', isEmpty);
            if (!isEmpty) {
                let total = 0;
                cartItemsContainer.innerHTML = cart.map(item => {
                    const product = products.find(p => p.id === item.id);
                    total += product.price * item.quantity;
                    return `<div class="cart-item"><div class="cart-item-img"></div><div class="cart-item-details"><div>${product.name}</div><div>¥${product.price.toLocaleString()} x ${item.quantity}</div></div><div class="cart-item-actions"><button class="remove-from-cart-btn" data-id="${product.id}">削除</button></div></div>`;
                }).join('');
                cartTotalEl.textContent = `合計: ¥${total.toLocaleString()}`;
                addGooglePayButtonToCart(total);
            }
            updateCartBadge();
        };

        const updateCartBadge = () => {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartBadge.textContent = totalItems;
            cartBadge.classList.toggle('hidden', totalItems === 0);
        };
        
        const showUserProfile = () => {
            const historyHtml = purchaseHistory.length > 0 ? purchaseHistory.map(order => `<div class="history-item"><div class="history-item-details">${order.items.map(p => `${p.name} (x${p.quantity})`).join('<br>')}</div><div class="history-item-date">${order.date}</div></div>`).join('') : '<p>購入履歴はありません。</p>';
            const favoritesHtml = favorites.length > 0 ? favorites.map(favId => { const p = products.find(p => p.id === favId); return `<div class="favorite-item"><span>${p.name}</span><span>¥${p.price.toLocaleString()}</span></div>` }).join('') : '<p>お気に入り商品はありません。</p>';
            const premiumStatusHtml = isPremiumMember ? `<p>プレミアムメンバーです。</p><button id="cancel-premium-btn" class="btn btn-danger">メンバーシップを解約する</button>` : `<p>プレミアムメンバーではありません。</p>`;
            getEl('user-profile-content').innerHTML = `<div class="profile-section"><strong>ユーザーID:</strong><p style="word-break:break-all;">${userId}</p></div><div class="profile-section"><strong>メンバーシップ:</strong>${premiumStatusHtml}</div><div class="profile-section"><h4>購入履歴</h4>${historyHtml}</div><div class="profile-section"><h4>お気に入り</h4>${favoritesHtml}</div><div class="profile-section" style="margin-top: 30px;"><button id="reset-data-btn" class="btn btn-danger">全データリセット</button></div>`;
            userProfileModal.classList.add('visible');
        };

        const updatePremiumStatusUI = () => {
            premiumStatusEl.innerHTML = isPremiumMember ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/></svg> Premium` : '';
            premiumButton.classList.toggle('hidden', isPremiumMember);
            premiumModal.querySelector('.feature-list').innerHTML = `<li><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/></svg>対象商品の無料配送</li><li><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/></svg>無料のお急ぎ便</li>`;
        };
        
        const subscribeToPremium = () => { isPremiumMember = true; localStorage.setItem('isPremiumMember', 'true'); updatePremiumStatusUI(); alert('プレミアムメンバーシップへようこそ！'); premiumModal.classList.remove('visible'); };
        const cancelPremium = () => { if (confirm('本当にプレミアムメンバーシップを解約しますか？')) { isPremiumMember = false; localStorage.removeItem('isPremiumMember'); updatePremiumStatusUI(); alert('メンバーシップを解約しました。'); userProfileModal.classList.remove('visible'); } };
        const addReview = (productId, text) => { products.find(p => p.id === productId).reviews.push({ author: 'あなた', text: text }); getEl('review-text').value = ''; renderReviews(productId); };
        const toggleFavorite = (productId) => {
            const btn = document.querySelector(`.favorite-btn[data-id="${productId}"]`);
            if (favorites.includes(productId)) favorites = favorites.filter(id => id !== productId);
            else favorites.push(productId);
            btn.classList.toggle('favorited');
            localStorage.setItem('favorites', JSON.stringify(favorites));
        };
        const resetAllData = () => {
            if (confirm('本当にすべてのデータをリセットしますか？この操作は元に戻せません。')) {
                localStorage.removeItem('userId');
                localStorage.removeItem('isPremiumMember');
                localStorage.removeItem('favorites');
                localStorage.removeItem('purchaseHistory');
                alert('すべてのデータをリセットしました。ページを再読み込みします。');
                location.reload();
            }
        };

        // --- Google Pay ---
        let paymentsClient = null;
        window.onGooglePayLoaded = () => {
            paymentsClient = new google.payments.api.PaymentsClient({
                environment: 'TEST',
                paymentDataCallbacks: { onPaymentAuthorized: (paymentData) => new Promise(resolve => setTimeout(() => resolve({ transactionState: 'SUCCESS' }), 1000)) }
            });
            addGooglePayButtonToPremium();
        };
        
        const createGooglePayRequest = (price) => {
            const baseRequest = { apiVersion: 2, apiVersionMinor: 0 };
            const tokenizationSpecification = { type: 'PAYMENT_GATEWAY', parameters: { gateway: 'example', gatewayMerchantId: 'exampleGatewayMerchantId' }};
            const cardPaymentMethod = { type: 'CARD', parameters: { allowedAuthMethods: ["PAN_ONLY", "CRYPTOGRAM_3DS"], allowedCardNetworks: ["AMEX", "DISCOVER", "INTERAC", "JCB", "MASTERCARD", "VISA"] }, tokenizationSpecification: tokenizationSpecification };
            return { ...baseRequest, allowedPaymentMethods: [cardPaymentMethod], transactionInfo: { totalPriceStatus: 'FINAL', totalPrice: price, currencyCode: 'JPY', countryCode: 'JP' }, merchantInfo: { merchantName: 'デモストア', merchantId: '01234567890123456789' }, callbackIntents: ['PAYMENT_AUTHORIZATION']};
        };

        const processPayment = (paymentDataRequest, onSuccess) => {
            const spinner = getEl('loadingOverlay');
            spinner.style.display = 'flex';
            setTimeout(() => { spinner.style.opacity = '1'; }, 10);
            paymentsClient.loadPaymentData(paymentDataRequest)
                .then(paymentData => onSuccess(paymentData))
                .catch(err => { if (err.statusCode !== 'CANCELED') alert(`エラーが発生しました: ${err.statusMessage || '詳細不明'}`); })
                .finally(() => { spinner.style.opacity = '0'; setTimeout(() => { spinner.style.display = 'none'; }, 300); });
        };

        const addGooglePayButtonToCart = (totalPrice) => {
            if (!paymentsClient) return;
            const container = getEl('gpay-cart-container'); container.innerHTML = '';
            const button = paymentsClient.createButton({
                onClick: () => processPayment(createGooglePayRequest(totalPrice.toString()), () => {
                    alert('デモ決済が完了しました！');
                    purchaseHistory.unshift({ date: new Date().toLocaleString('ja-JP'), items: cart.map(item => ({...products.find(p => p.id === item.id), quantity: item.quantity })) });
                    localStorage.setItem('purchaseHistory', JSON.stringify(purchaseHistory));
                    cart = [];
                    updateCart();
                    cartModal.classList.remove('visible');
                }),
                buttonColor: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'white' : 'black',
                buttonType: 'buy', buttonSizeMode: 'fill'
            });
            container.appendChild(button);
        };

        const addGooglePayButtonToPremium = () => {
            if (!paymentsClient) return;
            const container = getEl('gpay-premium-container'); container.innerHTML = '';
            const button = paymentsClient.createButton({
                onClick: () => processPayment(createGooglePayRequest('600'), subscribeToPremium),
                buttonColor: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'white' : 'black',
                buttonType: 'subscribe', buttonSizeMode: 'fill'
            });
            container.appendChild(button);
        };

        init();
    });
    </script>
</body>
</html>
